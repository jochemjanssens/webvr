<html>
  <head>
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
  </head>
  <body>
    <audio class="audio" preload="auto" controls src="./assets/audio/talk.mp3"></audio>

    <a-scene>
      <a-box position="0 2 -3" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="2.1 2 -2.1" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="0 2 3" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="2.1 2 2.1" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="3 2 0" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="-2.1 2 2.1" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="-3 2 0" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-box position="-2.1 2 -2.1" rotation="0 45 0" height="2" color="#4CC3D9"></a-box>
      <a-plane rotation="-90 0 0" width="30" height="30" color="#222"></a-plane>

    </a-scene>
    <script type="text/javascript">
      const xPos = [0, 2.1, 0, 2.1, 3, -2.1, -3, -2.1];
      const zPos = [-3, -2.1, 3, 2.1, 0, 2.1, 0, -2.1];

      let analyzer;
      const elements = 7; //1024 zero based
      let audio;

      let max = 255;

      const init  = () => {
        setupEquilizer();
        show();
      }

      const setupEquilizer = () => {
        audio = document.querySelector(`audio`);
        const audioCtx = new AudioContext();
        analyzer = audioCtx.createAnalyser();

        const sourceNode = audioCtx.createMediaElementSource(audio);
        sourceNode.connect(analyzer);
        sourceNode.connect(audioCtx.destination);
      };

      const show = () => {
        const data = new Uint8Array(analyzer.frequencyBinCount);
        analyzer.getByteFrequencyData(data);

        $elements = document.querySelectorAll('a-box');
        $elements.forEach((element, counter)=>{

          if(data[counter] > max){
            max = data[counter];
            console.log(max);
          }
          const height = (data[counter]/max*4);
          //const height = 4;
          element.setAttribute('height', height);
          element.setAttribute('color', `rgb(${data[counter]}, ${data[counter]}, 255)`);
          element.setAttribute('position', `${xPos[counter]}, ${height/2}, ${zPos[counter]}`);
        });
        window.requestAnimationFrame(show);
      }

      init();
    </script>
  </body>
</html>
